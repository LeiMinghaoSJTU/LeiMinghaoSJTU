name: WakaTime Metrics Updater

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-readme:
    name: Update WakaTime Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          
      # 添加前置检查步骤
      - name: Check WakaTime API status
        run: |
          response=$(curl -s -H "Authorization: Basic $(echo -n ${{ secrets.WAKATIME_API_KEY }} | base64)" "https://wakatime.com/api/v1/users/current/stats/last_7_days")
          echo "API Response: $response"
          # 检查响应是否包含数据
          if echo "$response" | grep -q '"data":\[\]'; then
            echo "No data available from WakaTime API"
            exit 1
          fi
          
      - name: Update WakaTime Metrics
        uses: anmol098/waka-readme-stats@v4.0.0
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.PAT }}
          SHOW_LANGUAGE: "True"
          # 简化配置，移除可能的问题源
          
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "🔄 Auto-update WakaTime metrics" || echo "No changes to commit"
          git push
