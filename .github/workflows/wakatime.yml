name: WakaTime Metrics Updater

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-readme:
    name: Update WakaTime Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          
      # æ·»åŠ å‰ç½®æ£€æŸ¥æ­¥éª¤
      - name: Check WakaTime API status
        run: |
          response=$(curl -s -H "Authorization: Basic $(echo -n ${{ secrets.WAKATIME_API_KEY }} | base64)" "https://wakatime.com/api/v1/users/current/stats/last_7_days")
          echo "API Response: $response"
          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«æ•°æ®
          if echo "$response" | grep -q '"data":\[\]'; then
            echo "No data available from WakaTime API"
            exit 1
          fi
          
      - name: Update WakaTime Metrics
        uses: anmol098/waka-readme-stats@v4.0.0
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.PAT }}
          SHOW_LANGUAGE: "True"
          # ç®€åŒ–é…ç½®ï¼Œç§»é™¤å¯èƒ½çš„é—®é¢˜æº
          
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ”„ Auto-update WakaTime metrics" || echo "No changes to commit"
          git push
